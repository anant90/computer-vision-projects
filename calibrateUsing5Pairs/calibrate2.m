% Calibration using three chessboard planes

im = imread('tiles.JPG');
imshow(im);

%Find 5 pairs of perpendicular lines pi:
mp1 = [450 59 1];
rp1 = [752 153 1];
lp1 = [262 235 1];

mp2 = [581 352 1];
rp2 = [375 593 1];
lp2 = lp1;

mp3 = [534 1096 1];
lp3 = [122 883 1];
rp3 = [761 760 1];

mp4 = [752 153 1];
lp4 = [854 36 1];
rp4 = [1093 263 1];

c11 = lp1;
c12 = mp3;
c21 = rp2;
c22 = [941 486 1];

l1 = cross(lp1,mp1); l1 = l1./l1(3);
m1 = cross(mp1,rp1); m1 = m1./m1(3);
l2 = cross(lp2,mp2); l2 = l2./l2(3);
m2 = cross(mp2,rp2); m2 = m2./m2(3);
l3 = cross(lp3,mp3); l3 = l3./l3(3);
m3 = cross(mp3,rp3); m3 = m3./m3(3);
l4 = cross(lp4,mp4); l4 = l4./l4(3);
m4 = cross(mp4,rp4); m4 = m4./m4(3);
l5 = cross(c11,c12); l5 = l5./l5(3);
m5 = cross(c21,c22); m5 = m5./m5(3);

A1 = [m1(1)*l1(1) (m1(1)*l1(2)+m1(2)*l1(1))/2 m1(2)*l1(2) (m1(1)*l1(3)+m1(3)*l1(1))/2 (m1(2)*l1(3)+m1(3)*l1(2))/2 m1(3)*l1(3)];
A2 = [m2(1)*l2(1) (m2(1)*l2(2)+m2(2)*l2(1))/2 m2(2)*l2(2) (m2(1)*l2(3)+m2(3)*l2(1))/2 (m2(2)*l2(3)+m2(3)*l2(2))/2 m2(3)*l2(3)];
A3 = [m3(1)*l3(1) (m3(1)*l3(2)+m3(2)*l3(1))/2 m3(2)*l3(2) (m3(1)*l3(3)+m3(3)*l3(1))/2 (m3(2)*l3(3)+m3(3)*l3(2))/2 m3(3)*l3(3)];
A4 = [m4(1)*l4(1) (m4(1)*l4(2)+m4(2)*l4(1))/2 m4(2)*l4(2) (m4(1)*l4(3)+m4(3)*l4(1))/2 (m4(2)*l4(3)+m4(3)*l4(2))/2 m4(3)*l4(3)];
A5 = [m5(1)*l5(1) (m5(1)*l5(2)+m5(2)*l5(1))/2 m5(2)*l5(2) (m5(1)*l5(3)+m5(3)*l5(1))/2 (m5(2)*l5(3)+m5(3)*l5(2))/2 m5(3)*l5(3)];


A = [A1; A2; A3; A4; A5];
[U,D,V] = svd(A); % 'Economy' decomposition for speed

w = [0 0 0; 0 0 0; 0 0 0];
w(1,1) = V(1,6)/2;
w(1,2) = V(2,6)/2;
w(1,3) = V(4,6)/2;
w(2,2) = V(3,6)/2;
w(3,3) = V(6,6)/2;
w(2,3) = V(5,6)/2;

w = w+transpose(w);
w = inv(w);
w
%c = chol(real(w));
%c = c./c(3,3)



